<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
		<title>我的订单</title>
		<script src="./js/jquery-3.5.1.min.js" type="text/javascript" charset="utf-8"></script>
		<script src="layui-v2.6.8/layui/layui.js" type="text/javascript" charset="utf-8"></script>
		<script src="js/gongju.js" type="text/javascript" charset="utf-8"></script>
		<link rel="stylesheet" type="text/css" href="css/index.css"/>
		<link rel="stylesheet" type="text/css" href="css/myorder.css"/>
		<style type="text/css" media="all">
		    body{
		        overflow:hidden;
		        width: 100%;
		    }
			#app{
				overflow:hidden;
				height: 100vh;
			}
			#myorder-yuan-top{
				height: 20px;
				width: 92%;
				margin-left: 4%;
				border: 1px solid red;
			}
		</style>
	</head>
	<body>
		<div class="jia_zai_zhong">
			<div class="jia_zai_zhong_all">
				<div class="jia_zai_zhong_img">
					<img src="./img/jia_zai_zhong.png" />
				</div>
				<div class="jia_zai_zhong_text">
					<div class="loader-inner ball-beat">
					  <div></div>
					  <div></div>
					  <div></div>
					</div>
					
					<div class="loader-inner ball-beat" style="margin-left: 5px;">
					  <div></div>
					  <div></div>
					  <div></div>
					</div>
				</div>
			</div>
		</div>
		<div class="mask"></div>
		<div id="app">
			<div class="div-one-bg"></div>
			<div class="myorder-title">
				订单信息
			</div>
			<div class="myorder-xiaofei">
				消费订单：<span class="myorder-type-one-dan-count"></span>  总消费：¥<span class="myorder-type-one-dan-sum"></span>
			</div>
			<div class="myorder-type">
				<div class="myorder-type-one myorder-type-shuzi">
					<div class="myorder-type-one-all myorder-type-one-dan-count" data-shu="all">
						
					</div>
					<div class="myorder-type-one-dan myorder-type-one-dan-wait" data-value="充值中" data-shu="1">
						
					</div>
					<div class="myorder-type-one-dan myorder-type-one-dan-unused" data-value="未使用" data-shu="2">
						
					</div>
					<div class="myorder-type-one-dan myorder-type-one-dan-completed" data-value="已完成" data-shu="3">
						
					</div>
					<div class="myorder-type-one-dan myorder-type-one-dan-failure" data-value="失败" data-shu="4">
						
					</div>
				</div>
				<div class="myorder-type-one">
					<div class="myorder-type-one-all myorder-type-one-dan-all ac" data-shu="all">
						全部订单
					</div>
					<div class="myorder-type-one-dan myorder-type-one-dan-1" data-value="充值中" data-shu="1">
						待到账
					</div>
					<div class="myorder-type-one-dan myorder-type-one-dan-2" data-value="未使用" data-shu="2">
						未使用
					</div>
					<div class="myorder-type-one-dan myorder-type-one-dan-3" data-value="已完成" data-shu="3">
						已完成
					</div>
					<div class="myorder-type-one-dan myorder-type-one-dan-4" data-value="失败" data-shu="4">
						已关闭
					</div>
				</div>
			</div>
			<!-- <div class="myorder-dan">
				<div class="myorder-dan-zi">
						<div class="myorder-dan-zi-order">
							订单号：1220221011220022211
						</div>
						<div class="myorder-dan-zi-zhuangtai">
							未使用
						</div>
						<div class="myorder-dan-zi-img">
							<img src="./img/zhongguoyidong.png" alt="状态" />
						</div>
						<div class="myorder-dan-zi-type">
							话费充值
						</div>
						<div class="myorder-dan-zi-danwei">
							¥
						</div>
						<div class="myorder-dan-zi-jine">
							50.00
						</div>
						<div class="myorder-dan-zi-shuliang">
							×1
						</div>
						<div class="myorder-dan-zi-jine-txt">
							共1件商品，总金额
						</div>
						<div class="myorder-dan-zi-jines">
							¥50.00
						</div>
						<div class="myorder-dan-button">
							查看详情
						</div>
					</div>
				<div class="myorder-dan-zi">
					<div class="myorder-dan-zi-order">
						订单号：1220221011220022211
					</div>
					<div class="myorder-dan-zi-zhuangtai">
						未使用
					</div>
					<div class="myorder-dan-zi-img">
						<img src="./img/zhongguoyidong.png" alt="状态" />
					</div>
					<div class="myorder-dan-zi-type">
						话费充值
					</div>
					<div class="myorder-dan-zi-danwei">
						¥
					</div>
					<div class="myorder-dan-zi-jine">
						50.00
					</div>
					<div class="myorder-dan-zi-shuliang">
						×1
					</div>
					<div class="myorder-dan-zi-jine-txt">
						共1件商品，总金额
					</div>
					<div class="myorder-dan-zi-jines">
						¥50.00
					</div>
					<div class="myorder-dan-button">
						查看券码
					</div>
				</div>
				<div class="myorder-dan-zi">
					<div class="myorder-dan-zi-order">
						订单号：1220221011220022211
					</div>
					<div class="myorder-dan-zi-zhuangtai">
						未使用
					</div>
					<div class="myorder-dan-zi-img">
						<img src="./img/zhongguoyidong.png" alt="状态" />
					</div>
					<div class="myorder-dan-zi-type">
						话费充值
					</div>
					<div class="myorder-dan-zi-danwei">
						¥
					</div>
					<div class="myorder-dan-zi-jine">
						50.00
					</div>
					<div class="myorder-dan-zi-shuliang">
						×1
					</div>
					<div class="myorder-dan-zi-jine-txt">
						共1件商品，总金额
					</div>
					<div class="myorder-dan-zi-jines">
						¥50.00
					</div>
					<div class="myorder-dan-button">
						查看详情
					</div>
				</div>
			</div> -->
			<div class="myorder-dan" id="myorder-dan">
				<div id="myorder-dan-one">
					
				</div>
				<div class="myorder-yuansu">
					<div class="">
						<img src="./img/xiangshangjiantou.png" />
					</div>
					<div class="">
						向上拉取获取更多订单
					</div>
				</div>
			</div>
			<div class="myorder-ke-fu">
				客服电话：<a href="tel: 400-006-7720">400-006-7720</a>
			</div>
		</div>
		<script type="text/javascript">
// 			localStorage.setItem("userId","1");
			var myorderdan = $(window).height() - $(".myorder-dan").offset().top - 40;
			$('.myorder-dan').css('height',myorderdan);
			//刷新第几页的数据
			var dijiye = 1;
			// 判断是否还有更多的数据，没有：1，有：0
			var more_data = 1;
			// 判断当前请求的类型,全部：1，带有类型：0
			var type_qing_qiu = "全部";
			// 渲染图片
			function img_pan_duan(type,value,value1){
				if(type == "直充类"){
					return imgUrl(value);
				}else if(type == "卡券类"){
					return imgUrl(value);
				}else{
					return "./img/zhongguoyidong.png";
				}
			}
			//是否显示券码
			function shi_fou_xian_shi_quan_ma(type,value,orderHao,tuiKuanYuanYin,du){
				if(type == "卡券类"){
					if(value == "已完成"){
						var str = ""
						if(tuiKuanYuanYin == undefined){
							// <div class='myorder-dan-button-tui' data-value="+orderHao+">申请退款</div>
							str = "<div class='myorder-dan-button' data-value="+orderHao+">查看券码</div>";
						}else if(tuiKuanYuanYin == "待处理"){
							// <div class='myorder-dan-button-tui_Y' data-value="+orderHao+">申请退款中</div>
							str = "<div class='myorder-dan-button' data-value="+orderHao+">查看券码</div>";
						}else if(tuiKuanYuanYin == "已退款" || tuiKuanYuanYin == "已拒绝"){
							if(du == 1){	
								// <div class='myorder-dan-button_jin_du ac myorder-dan-button_jin_du_wei' data-value="+orderHao+">退款进度<div class='myorder-dan-button_wei'>1</div></div>
								str = "<div class='myorder-dan-button' data-value="+orderHao+">查看券码</div>";
							}else if(du == 0){
								// <div class='myorder-dan-button_jin_du myorder-dan-button_jin_du_yi' data-value="+orderHao+">退款进度<div class='myorder-dan-button_wei'>1</div></div>
								str = "<div class='myorder-dan-button' data-value="+orderHao+">查看券码</div>";
							}
						}
						return str;
					}else{
						return "";
					}
				}else{
				    return "";
				}
			    
			}
			//将失败转化为已关闭
			function shi_bai_zhuan_guan_bi(value){
				if(value == "失败"){
					return "已关闭";
				}else if(value == "未支付"){
				    return "已关闭";
				}else if(value == "缺货"){
				    return "已关闭";
				}else{
					return value;
				}
			}
			function name_chu_li(value){
			    if(value == null){
			        return "话费充值";
			    }else{
			        return value;
			    }
			}
			// 数据加载方法
			function shujujiazai(value){
				type_qing_qiu = "全部";
				$.ajax({
					url:"http://172.16.7.179:8080/api/token/userOrder",
				// 	url:"http://106.15.56.132:8765/api/token/userOrder",
					type: "POST",
					async: false,
					data:{"userId":localStorage.getItem("userId"),"page":((value - 1)*5)},
					dataType:'json',
					success:function(result){
						if(result.code == 0){
							var order = '';
							for(var i = 0;i < result.value.length;i++){
								order += '<div class="myorder-dan-zi"><div class="myorder-dan-zi-order">订单号：'+result.value[i].orderHao+'</div><div class="myorder-dan-zi-zhuangtai">'+shi_bai_zhuan_guan_bi(result.value[i].orderChongZhiStatus)+'</div><div class="myorder-dan-zi-img"><img src="'+img_pan_duan(result.value[i].type,result.value[i].pinImg,result.value[i].dzPinImg)+'" alt="状态" /></div><div class="myorder-dan-zi-type">'+name_chu_li(result.value[i].shangPinName)+'</div><div class="myorder-dan-zi-danwei">¥</div><div class="myorder-dan-zi-jine">'+jine_if(result.value[i].amount)+'</div><div class="myorder-dan-zi-shuliang">×1</div><div class="myorder-dan-zi-jine-txt">共1件商品，总金额</div><div class="myorder-dan-zi-jines">¥'+jine_if(result.value[i].amount)+'</div>'+shi_fou_xian_shi_quan_ma(result.value[i].type,result.value[i].orderChongZhiStatus,result.value[i].orderHao,result.value[i].tuiKuanYuanYin,result.value[i].tuiKuanShiFouYiDu)+'</div>'
							}
							if(result.value.length < 4){
								more_data = 1;
								// layer.msg("当前没有更多的数据了");
							}else{
								more_data = 0;
							}
							$("#myorder-dan-one").append(order);
						}else{
							layer.msg("服务器响应失败请联系管理员");
						}
					},error:function(result){
						layer.msg("服务器响应失败请联系管理员");
						layer.closeAll('loading');
					}
				});
				if(more_data != 0){
					$('.myorder-yuansu').css("display","none");
				}else{
					$('.myorder-yuansu').css("display","block");
				}
				$.ajax({
					url:"http://172.16.7.179:8080/api/token/userSum",
				// 	url:"http://106.15.56.132:8765/api/token/userSum",
					type: "POST",
					async: false,
					data:{"userId":localStorage.getItem("userId")},
					dataType:'json',
					success:function(result){
						layer.closeAll('loading');
						if(result.code == 0){
							$(".myorder-type-one-dan-count").html(result.value.count);
							$(".myorder-type-one-dan-completed").html(result.value.completed+result.value.completedOne);
							$(".myorder-type-one-dan-failure").html(result.value.failure+result.value.failureOne+result.value.failureTwo);
							$(".myorder-type-one-dan-wait").html(result.value.wait);
							$(".myorder-type-one-dan-unused").html(result.value.unused);
							if(result.value.count == 0){
								$(".myorder-type-one-dan-sum").html(jine_if(0));
							}else{
								$(".myorder-type-one-dan-sum").html(jine_if(result.value.sum));
							}
						}else{
							layer.msg("服务器响应失败请联系管理员");
						}
					},error:function(result){
						layer.msg("服务器响应失败请联系管理员");
						layer.closeAll('loading');
					}
				});
			}
			//点击未读
			$("body").on("click",".myorder-dan-button_jin_du_wei",function(){
				var order_hao = $(this).attr("data-value");
				$.ajax({
					url:"http://172.16.7.179:8080/api/token/selectAll",
					// url:"http://106.15.56.132:8765/api/token/selectAll",
					type: "POST",
					async: false,
					data:{"order":order_hao},
					dataType:'json',
					success:function(result){
						if(result.code == 0){
							layer.prompt({title: '退款进度',btn:[] ,maxlength: 50,content:'<div class="tan_kuang"><div class="tan_kuang_one"><div class="tan_kuang_one_title">进度：</div><div class="tan_kuang_one_input">'+result.value[0].tuiKuanZhuangTai+'</div></div><div class="tan_kuang_two"><div class="tan_kuang_two_title">拒绝理由：</div><div class="tan_kuang_two_input"><textarea style="disabled" class="layui-layer-textarea">'+result.value[0].keFuHuiFu+'</textarea></div></div><div class="tan_kuang_there">如有疑问，可联系客服：<a href="tel:400-006-7720">400-006-7720</a></div></div>'}, function(text, index){
							  layer.close(index);
							});
						}else if(result.code == 3){
							layer.msg("服务器响应失败请联系管理员");
						}
					},error:function(result){
						layer.msg("服务器响应失败请联系管理员");
					}
				});
				var zhuang_tai = "0";
				$.ajax({
					url:"http://172.16.7.179:8080/api/token/updateDu",
					// url:"http://106.15.56.132:8765/api/token/updateDu",
					type: "POST",
					async: false,
					data:{"order":order_hao},
					dataType:'json',
					success:function(result){
						if(result.code == 0){
							zhuang_tai = "1";
						}else if(result.code == 3){
							layer.msg("服务器响应失败请联系管理员");
						}
					},error:function(result){
						layer.msg("服务器响应失败请联系管理员");
					}
				});
				if(zhuang_tai == "1"){
					$(this).removeClass("ac");
					$(this).removeClass("myorder-dan-button_jin_du_wei");
					$(this).addClass("myorder-dan-button_jin_du_yi");
				}
			});
			//点击已读
			$("body").on("click",".myorder-dan-button_jin_du_yi",function(){
				var order_hao = $(this).attr("data-value");
				$.ajax({
					url:"http://172.16.7.179:8080/api/token/selectAll",
					// url:"http://106.15.56.132:8765/api/token/selectAll",
					type: "POST",
					async: false,
					data:{"order":order_hao},
					dataType:'json',
					success:function(result){
						if(result.code == 0){
							layer.prompt({title: '退款进度',btn:[] ,maxlength: 50,content:'<div class="tan_kuang"><div class="tan_kuang_one"><div class="tan_kuang_one_title">进度：</div><div class="tan_kuang_one_input">'+result.value[0].tuiKuanZhuangTai+'</div></div><div class="tan_kuang_two"><div class="tan_kuang_two_title">拒绝理由：</div><div class="tan_kuang_two_input"><textarea style="disabled" class="layui-layer-textarea">'+result.value[0].keFuHuiFu+'</textarea></div></div><div class="tan_kuang_there">如有疑问，可联系客服：<a href="tel:400-006-7720">400-006-7720</a></div></div>'}, function(text, index){
							  layer.close(index);
							});
						}else if(result.code == 3){
							layer.msg("服务器响应失败请联系管理员");
						}
					},error:function(result){
						layer.msg("服务器响应失败请联系管理员");
					}
				});
			});
			//带类型的数据渲染
			function type_shu_ju_xuan_ran(value,zhuangTai){
				type_qing_qiu = zhuangTai;
				$.ajax({
					url:"http://172.16.7.179:8080/api/token/orderZhuangTai",
				// 	url:"http://106.15.56.132:8765/api/token/orderZhuangTai",
					type: "POST",
					async: false,
					data:{"userId":localStorage.getItem("userId"),"page":((value - 1)*5),"orderChongZhiStatus":zhuangTai},
					dataType:'json',
					success:function(result){
						layer.closeAll('loading');
						if(result.code == 0){
							var order = '';
							for(var i = 0;i < result.value.length;i++){
								order += '<div class="myorder-dan-zi"><div class="myorder-dan-zi-order">订单号：'+result.value[i].orderHao+'</div><div class="myorder-dan-zi-zhuangtai">'+shi_bai_zhuan_guan_bi(result.value[i].orderChongZhiStatus)+'</div><div class="myorder-dan-zi-img"><img src="'+img_pan_duan(result.value[i].type,result.value[i].pinImg,result.value[i].dzPinImg)+'" alt="状态" /></div><div class="myorder-dan-zi-type">'+name_chu_li(result.value[i].shangPinName)+'</div><div class="myorder-dan-zi-danwei">¥</div><div class="myorder-dan-zi-jine">'+jine_if(result.value[i].amount)+'</div><div class="myorder-dan-zi-shuliang">×1</div><div class="myorder-dan-zi-jine-txt">共1件商品，总金额</div><div class="myorder-dan-zi-jines">¥'+jine_if(result.value[i].amount)+'</div>'+shi_fou_xian_shi_quan_ma(result.value[i].type,result.value[i].orderChongZhiStatus,result.value[i].orderHao,result.value[i].tuiKuanYuanYin,result.value[i].tuiKuanShiFouYiDu)+'</div>'
							}
							if(result.value.length < 4){
								more_data = 1;
								// layer.msg("当前没有更多的数据了");
							}else{
								more_data = 0;
							}
							$("#myorder-dan-one").append(order);
						}else{
							layer.msg("服务器响应失败请联系管理员");
						}
					},error:function(result){
						layer.msg("服务器响应失败请联系管理员");
						layer.closeAll('loading');
					}
				});
				if(more_data != 0){
					$('.myorder-yuansu').css("display","none");
				}else{
					$('.myorder-yuansu').css("display","block");
				}
			}
			// 点击不同状态
			$(".myorder-type-one-dan").click(function(){
				$(".ac").removeClass("ac");
				$(".myorder-type-one-dan-"+$(this).attr("data-shu")).addClass("ac");
				$("#myorder-dan-one").html('');
				//加载层-风格3
				layer.load(2);
				var zhaung_tai_ji_lu = $(this).attr("data-value");
				setTimeout(function () {
					dijiye = 1;
					$('.myorder-yuansu').css("display","none");
					type_shu_ju_xuan_ran(dijiye,zhaung_tai_ji_lu);
				},1000);
			});
			if(more_data != 0){
				$('.myorder-yuansu').css("display","none");
			}else{
				$('.myorder-yuansu').css("display","block");
			}
			// 点击全部
			$(".myorder-type-one-all").click(function(){
				$(".ac").removeClass("ac");
				$(".myorder-type-one-dan-"+$(this).attr("data-shu")).addClass("ac");
				$("#myorder-dan-one").html('');
				//加载层-风格3
				layer.load(2);
				setTimeout(function () {
					dijiye = 1;
					$('.myorder-yuansu').css("display","none");
					shujujiazai(dijiye);
				},1000);
			})
			//加载层-风格3
			layer.load(2);
			setTimeout(function () {
				shujujiazai(dijiye);
			},1000);
			//金额进行处理
			function jine_if(value){
				return value;
			}
			//获取元素是否在可视区域
			function isElementInViewport(el) {
			    var rect = el.getBoundingClientRect().top;
				if(more_data != 1){
					if(rect - ($("#myorder-dan").offset().top + $("#myorder-dan").height()) < 0){
						if(more_data == 1){
							layer.msg("没有更多的数据了")
						}else{
							//加载层-风格3
							layer.load(2);
							dijiye++;
							if(type_qing_qiu == "全部"){
								shujujiazai(dijiye);
							}else{
								type_shu_ju_xuan_ran(dijiye,type_qing_qiu);
							}
						}
					}
				}
			}
			$('#myorder-dan').scroll(function(){
				var ab = $(".myorder-yuansu")[0];
				isElementInViewport(ab);
			});
			// 点击查看券码
			$("#myorder-dan-one").on("click",".myorder-dan-button",function(){
				window.location.href = "myquanma.html?order="+$(this).attr("data-value");
			});
			// 点击申请退款
			$("body").on("click",'.myorder-dan-button-tui',function(){
				var order_hao = $(this).attr("data-value");
				layer.prompt({title: '是否需要申请退款？', formType: 2,maxlength: 50}, function(text, index){
				  layer.close(index);
				  $.ajax({
						url:"http://172.16.7.179:8080/api/token/shenQingTuiKuan",
						// url:"http://106.15.56.132:8765/api/token/shenQingTuiKuan",
						type: "POST",
						async: false,
						data:{"order":order_hao,"yuanyin":text},
						dataType:'json',
						success:function(result){
							if(result.code == 0){
								layer.msg('退款申请已提交，我们将会在48小时内为您进行处理');
							}else if(result.code == 1){
								layer.msg("不可重复提交");
							}else if(result.code == 3){
								layer.msg("服务器响应失败请联系管理员");
							}
						},error:function(result){
							layer.msg("服务器响应失败请联系管理员");
						}
					});
				});
			});
		</script>
		<script type="text/javascript">
			//手指拉取的方向
			var shou_zhi_la_qu = 0;
			var startx, starty;
			    //获得角度
			    function getAngle(angx, angy) {
			        return Math.atan2(angy, angx) * 180 / Math.PI;
			    };
			 
			    //根据起点终点返回方向 1向上 2向下 3向左 4向右 0未滑动
			    function getDirection(startx, starty, endx, endy) {
			        var angx = endx - startx;
			        var angy = endy - starty;
			        var result = 0;
			 
			        //如果滑动距离太短
			        if (Math.abs(angx) < 2 && Math.abs(angy) < 2) {
			            return result;
			        }
			 
			        var angle = getAngle(angx, angy);
			        if (angle >= -135 && angle <= -45) {
			            result = 1;
			        } else if (angle > 45 && angle < 135) {
			            result = 2;
			        } else if ((angle >= 135 && angle <= 180) || (angle >= -180 && angle < -135)) {
			            result = 3;
			        } else if (angle >= -45 && angle <= 45) {
			            result = 4;
			        }
			 
			        return result;
			    }
			    //手指接触屏幕
			    document.addEventListener("touchstart", function(e) {
			        startx = e.touches[0].pageX;
			        starty = e.touches[0].pageY;
					shou_zhi_la_qu = 0;
			    }, false);
			    //手指离开屏幕
			    document.addEventListener("touchend", function(e) {
			        var endx, endy;
			        endx = e.changedTouches[0].pageX;
			        endy = e.changedTouches[0].pageY;
			        var direction = getDirection(startx, starty, endx, endy);
			        switch (direction) {
			            case 0:
			                // alert("未滑动！");
			                break;
			            case 1:
			                // alert("向上！")
							// shou_zhi_la_qu = "向上";
							// var ab = $(".myorder-yuansu")[0];
							// isElementInViewport(ab);
			                break;
			            case 2:
							// alert("向下！")
							shou_zhi_la_qu = "向下";
			                break;
			            case 3:
			                // alert("向左！")
			                break;
			            case 4:
			                // alert("向右！")
			                break;
			            default:
			        }
			    }, false);
		</script>
</html>
