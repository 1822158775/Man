<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
	<meta http-equiv="Access-Control-Allow-Origin" content="*" />
	<link rel="stylesheet" type="text/css" href="css/index.css"/>
	<link rel="stylesheet" type="text/css" href="./css/wechat.css"/>
    <title>全付通</title>
    <style type="text/css" media="all">
        body{
            overflow:hidden;
            width: 100%;
        }
    </style>
</head>

<body>
	<div class="jia_zai_zhong">
		<div class="jia_zai_zhong_all">
			<div class="jia_zai_zhong_img">
				<img src="./img/jia_zai_zhong.png" />
			</div>
			<div class="jia_zai_zhong_text">
				<div class="loader-inner ball-beat">
				  <div></div>
				  <div></div>
				  <div></div>
				</div>
				<div class="loader-inner ball-beat" style="margin-left: 5px;">
				  <div></div>
				  <div></div>
				  <div></div>
				</div>
			</div>
		</div>
	</div>
	<div class="mask"></div>
	<div id="app">
		<div class="kuang">
			<div class="kuang-one">
				<img src="img/200status.png" alt="状态图标">
			</div>
		</div>
		<div class="kuang-two">
			<p><span>购买成功!</span><br><span>系统正在进行为您充值</span></p>
		</div>
		<div class="kuang-there">
			<p><span>订单号：</span><span class="order"></span></p>
			<p><span>购买时间：</span><span class="data"></span></p>
			<p class="chongzhihaoma"><span>充值号码：</span><span class="phone"></span></p>
			<p class="kefu" style="display: none;"><span>客服电话：</span><a href="tel: 400-006-7720">400-006-7720</a></p>
		</div>
		<div class="kuang-button">
			<div class="kuang-button-fanhui">
				<span>返回主页</span>
			</div>
			<div class="kuang-button-dingdan">
				<span>订单信息</span>
			</div>
		</div>
	</div>
	<div id="app-2">
		<div class="kuang">
			<div class="kuang-one">
				<img src="img/dengdai.png" alt="状态图标">
			</div>
			<div class="kuang-two">
				<p><span>......支付中......</span><br>
				<span>......请稍等......</span></p>
			</div>
			<div class="kuang-kefu">
				<span>客服电话：<a href="tel: 400-006-7720">400-006-7720</a></span>
			</div>
			<div class="kuang-button">
				<div class="kuang-button-fanhui">
					<span>支付完成</span>
				</div>
				<div class="kuang-button-dingdan">
					<span>取消支付</span>
				</div>
			</div>
		</div>
	</div>
	<div id="app-3">
		<div class="kuang">
			<div class="kuang-one">
				<img src="img/error.png" alt="状态图标">
			</div>
			<div class="kuang-two">
				<p><span>购买失败！</span><br>
				<span>您可重试或者联系客服人员</span></p>
			</div>
			<div class="kuang-kefu">
				<span>客服电话：<a href="tel: 400-006-7720">400-006-7720</a></span>
			</div>
			<div class="kuang-button">
				<div class="kuang-button-fanhui">
					<span>返回主页</span>
				</div>
				<div class="kuang-button-dingdan">
					<span>订单信息</span>
				</div>
			</div>
		</div>
	</div>
	<form id="submitForm" style="display: none;" name="submitForm" method="post" action="https://ifop.citicbank.com/h5">
	  <input type="hidden" id="packet" value="" name="packet"  />
	  <input type="submit" name="" id="submit" value="提交" />
	</form>
</body>
<script src="./js/jquery-3.5.1.min.js" type="text/javascript" charset="utf-8"></script>
<script src="js/gongju.js" type="text/javascript" charset="utf-8"></script>
<script src="layui-v2.6.8/layui/layui.js" type="text/javascript" charset="utf-8"></script>
<script>

    var test2;
	//加载层-风格3
	layer.load(2);
	var order = GetRequest().order;
	var phone = GetRequest().phone;
	var data = GetRequest().data;
	var pinId = GetRequest().pinId;
	var pinCount = GetRequest().pinCount;
	var type = GetRequest().type;
	var gui = GetRequest().gui;
	var shanPinId = GetRequest().shanPinId;
	if(type == "2"){
	    type = "卡券类";
	    $(".chongzhihaoma").css("display","none");
	}else if(type == "1"){
	    type = "直充类"
	}
	if(gui == "1"){
        gui = "福司令";
    }else if(gui == "3"){
	    gui = "话费充值"
	}else{
        gui = "本地添加";
    }
    if(localStorage.getItem("url") != null){
		$.ajax({
			// url:"http://172.16.7.179:8080/api/token/orderHao",
			url:"http://172.16.7.179:8080/api/token/orderHao",
			type: "POST",
			async: false,
			data:{"order":localStorage.getItem("url")},
			success:function(result){
				$("#packet").val(result);
			},error:function(result){
				layer.msg("服务器响应失败请联系管理员");
			}
		});
        setTimeout(function () {
			localStorage.setItem("wechat",window.location.href);
			$("#submit").click();
			localStorage.removeItem("url");
		},1000);
    }else{
		jiantingzhifu(order);
    }
	//查看支付状态
	function jiantingzhifu(order){
		$.ajax({    
			url:"http://172.16.7.179:8080/api/token/verifystate",
			// url:"http://106.15.56.132:8765/api/token/verifystate",
            // url:"http://106.15.56.132:8765/api/token/verifystate",
			type: "POST",
			async: false,
			data:{"name":order,"userId":localStorage.getItem("userId"),"shangPinId":pinId,"count":pinCount,"type":type,"gui":gui},
			dataType:'json',
			success:function(result){
				layer.closeAll('loading');
				if(result.STT == "02"){
					//清除Interval的定时器,传入变量名(创建Interval定时器时定义的变量名)
					$('.order').html(order);
					$('.data').html(data);
					$('.phone').html(phone);
					off_order();
					$('#app').css("display","block");
					localStorage.setItem("query", 0);
					window.clearInterval(test2);
    				if(result.code == "-1"){
    				    layer.msg("当前库存不足，请联系客服进行退款");
    				    $('.kefu').css("display","block");
    				}
				} else if (result.STT == "01"){
					off_order();
					$('#app-2').css("display","block");
					$('.order').html('');
					$('.data').html('');
					$('.phone').html('');
					if(localStorage.getItem("query") < 1){
						off_order();
						$('#app-3').css("display","block");
						$('.order').html('');
						$('.data').html('');
						$('.phone').html('');
					}
				}else{
					off_order();
					$('#app-3').css("display","block");
					$('.order').html('');
					$('.data').html('');
					$('.phone').html('');
				}
			},error:function(result){
				layer.closeAll('loading');
				layer.msg('服务器响应失败请联系管理员');
			}
		});
	}
	//取消支付
	$("#app-2 .kuang-button-dingdan").click(function(){
	    $.ajax({
			url:"http://172.16.7.179:8080/api/token/quXiaoOrder",
			// url:"http://106.15.56.132:8765/api/token/quXiaoOrder",
			type: "POST",
			async: false,
			data:{"orderHao":order},
			dataType:'json',
			success:function(result){
				if(result.code == 0){
                    layer.msg("已取消支付");
					window.location.href = "index.html";
                 //    if(isSafari() == true){
            	    //     if(localStorage.getItem("off") != null){
            	    //         window.close();
            	    //         localStorage.removeItem("off");
            	    //     }else{
            	    //         javascript:history.go(-1);
            	    //     }
            	    // }else{
            	    //     javascript:history.go(-1);
            	    // }
				}else if(result.code == 200){
					jiantingzhifu(order);
				}else{
					layer.msg("服务器响应失败请联系管理员");
				}
			},error:function(result){
				layer.msg("服务器响应失败请联系管理员");
			}
		});
	});
	setTimeout(function () {
		if(localStorage.getItem("query") > 0){
			test2 = setInterval(function(){
			    if(localStorage.getItem("query") > 0){
    				localStorage.setItem("query", localStorage.getItem("query") - 1);
    			   //your codes
    			   jiantingzhifu(order);
    			   if(localStorage.getItem("query") < 1){
    				window.clearInterval(test2);
    			   }
			    }
			},3000)
		}
	},2000);
	function isSafari(){
        var ua = navigator.userAgent.toLowerCase();
        if (ua.indexOf('applewebkit') > -1 && ua.indexOf('mobile') > -1 && ua.indexOf('safari') > -1 &&
            ua.indexOf('linux') === -1 && ua.indexOf('android') === -1 && ua.indexOf('chrome') === -1 &&
            ua.indexOf('ios') === -1 && ua.indexOf('browser') === -1) {
            return true;
        }else{
            return false;
        }
    }
	// 点击刷新状态
	$("#app-2 .kuang-button-fanhui").click(function(){
		//加载层-风格3
		layer.load(2);
		setTimeout(function () {
			jiantingzhifu(order);
		},1000);
	});
	// 点击返回上一页
	$('#app-3 .kuang-button-fanhui').click(function(){
	    // if(isSafari() == true){
	    //     if(localStorage.getItem("off") != null){
	    //         window.close();
	    //         localStorage.removeItem("off");
	    //     }else{
	    //         javascript:history.go(-1);
	    //     }
	    // }else{
	    //     javascript:history.go(-1);
	    // }
		window.location.href = "index.html";
	});
	// 点击查看订单信息
	$("#app .kuang-button-dingdan").click(function(){
		window.location.href = "myorder.html";
	});
	//点击返回主页
	$("body").on("click","#app .kuang-button-fanhui",function(){
		window.location.href = "index.html";
	});
</script>
</html>